; Reverb queue worker - processes Reverb-Shopify sync jobs only
; Copy to /etc/supervisor/conf.d/reverb-worker.conf on server
; Run: sudo supervisorctl reread && sudo supervisorctl update
;
; Race condition handling:
; - ImportReverbOrderToShopify jobs check reverb_sync_running cache and release(120) if sync in progress
; - reverb:sync-all dispatches jobs only after fetch+inventory sync complete (via reverb:process-pending)
; - max-time=3600: worker exits after 1hr, supervisor restarts; prevents long-lived zombie workers

[program:reverb-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/invent/artisan queue:work database --queue=reverb --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/path/to/invent/storage/logs/reverb-worker.log
; Allow worker to finish current job before SIGTERM
stopwaitsecs=3600
